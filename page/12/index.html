<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tonymistark.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="安静地坐着学习">
<meta property="og:type" content="website">
<meta property="og:title" content="BLOG">
<meta property="og:url" content="https://tonymistark.github.io/page/12/index.html">
<meta property="og:site_name" content="BLOG">
<meta property="og:description" content="安静地坐着学习">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ice">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tonymistark.github.io/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>BLOG</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W6L4L92Z6Z"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W6L4L92Z6Z');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?99c70b2174a7fbe4af476f28bafb19a3";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/./atom.xml" title="BLOG" type="application/atom+xml">
<link rel="alternate" href="/./rss2.xml" title="BLOG" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">用心记录思想</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://tonymistark.github.io/2024/04/21/design-pattern/state/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ice">
      <meta itemprop="description" content="安静地坐着学习">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/21/design-pattern/state/" class="post-title-link" itemprop="url">State 状态模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-21 12:54:21" itemprop="dateCreated datePublished" datetime="2024-04-21T12:54:21+08:00">2024-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-25 15:56:47" itemprop="dateModified" datetime="2024-10-25T15:56:47+08:00">2024-10-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/design-pattern/" itemprop="url" rel="index"><span itemprop="name">design-pattern</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Intent-意图"><a href="#Intent-意图" class="headerlink" title="Intent 意图"></a>Intent 意图</h2><p>状态模式是一种行为设计模式，它允许对象在其内部状态更改时更改其行为。看起来好像对象更改了它的类。</p>
<div align="center"> <img src="/images/state-header.png"/><p style="text-align: center;"></p></div>


<h2 id="Problem-问题"><a href="#Problem-问题" class="headerlink" title="Problem 问题"></a>Problem 问题</h2><p>状态模式与有限状态机的概念密切相关。</p>
<div align="center"> <img src="/images/state-problem1.png"/><p style="text-align: center;">Finite-State Machine. 有限状态机。</p> </div>


<p>主要思想是，在任何给定的时刻，程序可以处于的状态数量是有限的。在任何唯一状态下，程序的行为都不同，程序可以立即从一种状态切换到另一种状态。但是，根据当前状态，程序可能会也可能不会切换到某些其他状态。这些切换规则（称为转换）也是有限的和预先确定的。</p>
<p>您也可以将此方法应用于对象。想象一下，我们有一个 您也可以将此方法应用于对象。想象一下，我们有一个 <code>Document</code> 类。文档可以处于以下三种状态之一： <code>Draft</code>、<code>Moderation</code> 和 <code>Published</code> 。<code>publish</code> 方法在每种状态下的工作方式略有不同： </p>
<ul>
<li>在<code>Draft</code>中，它会将文档移动到审核状态。</li>
<li>在<code>Moderation</code>中，它使文档公开，但前提是当前用户是管理员。</li>
<li>在<code>Published</code>中，它根本不做任何事情。</li>
</ul>
<div align="center"> <img src="/images/state-problem2.png"/><p style="text-align: center;">文档对象的可能状态和转换。</p></div>

<p>状态机通常使用大量条件语句（ <code>if</code> 或<code>switch</code> ）实现，这些条件语句根据对象的当前状态选择适当的行为。通常，此“状态”只是对象字段的一组值。即使你以前从未听说过有限状态机，你也可能至少实现过一次状态。以下代码结构是否敲响了警钟？ ）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Document</span> is</span><br><span class="line">    field state: string</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">publish</span><span class="params">()</span> is</span><br><span class="line">        <span class="title function_">switch</span> <span class="params">(state)</span></span><br><span class="line">            <span class="string">&quot;draft&quot;</span>:</span><br><span class="line">                state = <span class="string">&quot;moderation&quot;</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="string">&quot;moderation&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> (currentUser.role == <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                    state = <span class="string">&quot;published&quot;</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="string">&quot;published&quot;</span>:</span><br><span class="line">                <span class="comment">// Do nothing.</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>一旦我们开始向 <code>Document</code> 类中添加越来越多的状态和状态依赖行为，基于条件的状态机的最大弱点就会显现出来。大多数方法都会包含可怕的条件，这些条件根据当前状态选择方法的正确行为。像这样的代码很难维护，因为对转换逻辑的任何更改都可能需要更改每个方法中的状态条件。 类中添加越来越多的状态和状态依赖行为，基于条件的状态机的最大弱点就会显现出来。大多数方法都会包含可怕的条件，这些条件根据当前状态选择方法的正确行为。像这样的代码很难维护，因为对转换逻辑的任何更改都可能需要更改每个方法中的状态条件。</p>
<p>随着项目的发展，问题往往会变得更大。在设计阶段预测所有可能的状态和转变是相当困难的。因此，随着时间的流逝，使用一组有限的条件构建的精益状态机可能会变得一团糟。</p>
<h2 id="Solution-解决方案"><a href="#Solution-解决方案" class="headerlink" title="Solution 解决方案"></a>Solution 解决方案</h2><p>状态模式建议您为对象的所有可能状态创建新类，并将所有特定于状态的行为提取到这些类中。</p>
<p>原始对象（称为 context）不是自行实现所有行为，而是存储对表示其当前状态的状态对象之一的引用，并将所有与状态相关的工作委托给该对象。</p>
<div align="center"> <img src="/images/state-solution.png"/><p style="text-align: center;">文档将工作委托给状态对象。</p></div>

<p>若要将上下文转换为另一种状态，请将活动状态对象替换为表示该新状态的另一个对象。只有当所有状态类都遵循相同的接口，并且上下文本身通过该接口处理这些对象时，这才有可能。</p>
<p>此结构可能看起来类似于策略模式，但有一个关键区别。在状态模式中，特定状态可能相互了解并启动从一种状态到另一种状态的过渡，而策略几乎从不相互了解。</p>
<h2 id="Real-World-Analogy-真实世界的类比"><a href="#Real-World-Analogy-真实世界的类比" class="headerlink" title="Real-World Analogy 真实世界的类比"></a>Real-World Analogy 真实世界的类比</h2><p>智能手机中的按钮和开关的行为会根据设备的当前状态而有所不同：</p>
<ul>
<li>手机解锁后，按下按钮可以执行各种功能。</li>
<li>当手机锁定时，按任意按钮都会进入解锁屏幕。</li>
<li>当手机电量不足时，按任意按钮都会显示充电屏幕。</li>
</ul>
<h2 id="Structure-结构"><a href="#Structure-结构" class="headerlink" title="Structure 结构"></a>Structure 结构</h2><div align="center"> <img src="/images/state-structure.png"/><p style="text-align: center;"></p></div>

<ol>
<li><p>上下文存储对某个具体状态对象的引用，并将所有特定于状态的工作委托给它。上下文通过状态接口与状态对象进行通信。上下文公开一个 setter 用于向其传递新的状态对象。</p>
</li>
<li><p>State 接口声明特定于状态的方法。这些方法应该对所有具体状态都有意义，因为你不希望你的某些状态具有永远不会被调用的无用方法。</p>
</li>
<li><p>具体状态为特定于状态的方法提供自己的实现。为了避免在多个状态下重复相似的代码，您可以提供封装一些常见行为的中间抽象类。</p>
<p>状态对象可以存储对上下文对象的反向引用。通过此引用，状态可以从上下文对象中获取任何所需的信息，并启动状态转换。</p>
</li>
<li><p>上下文和具体状态都可以设置上下文的下一个状态，并通过替换链接到上下文的状态对象来执行实际的状态转换。</p>
</li>
</ol>
<h2 id="Pseudocode-伪代码"><a href="#Pseudocode-伪代码" class="headerlink" title="Pseudocode 伪代码"></a>Pseudocode 伪代码</h2><p>在此示例中，状态模式允许媒体播放器的相同控件以不同的方式运行，具体取决于当前播放状态。</p>
<div align="center"> <img src="/images/state-example.png"/><p style="text-align: center;"></p>使用状态对象更改对象行为的示例。</div>


<p>播放器的主要对象始终与一个状态对象相链接，该状态对象执行播放器的大部分工作。一些动作会将播放器当前的状态对象替换为另一个，这改变了播放器对用户交互的反应方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The AudioPlayer class acts as a context. It also maintains a</span></span><br><span class="line"><span class="comment">// reference to an instance of one of the state classes that</span></span><br><span class="line"><span class="comment">// represents the current state of the audio player.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AudioPlayer</span> is</span><br><span class="line">    field state: State</span><br><span class="line">    field UI, volume, playlist, currentSong</span><br><span class="line"></span><br><span class="line">    constructor <span class="title function_">AudioPlayer</span><span class="params">()</span> is</span><br><span class="line">        <span class="built_in">this</span>.state = <span class="keyword">new</span> <span class="title class_">ReadyState</span>(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Context delegates handling user input to a state</span></span><br><span class="line">        <span class="comment">// object. Naturally, the outcome depends on what state</span></span><br><span class="line">        <span class="comment">// is currently active, since each state can handle the</span></span><br><span class="line">        <span class="comment">// input differently.</span></span><br><span class="line">        UI = <span class="keyword">new</span> <span class="title class_">UserInterface</span>()</span><br><span class="line">        UI.lockButton.onClick(<span class="built_in">this</span>.clickLock)</span><br><span class="line">        UI.playButton.onClick(<span class="built_in">this</span>.clickPlay)</span><br><span class="line">        UI.nextButton.onClick(<span class="built_in">this</span>.clickNext)</span><br><span class="line">        UI.prevButton.onClick(<span class="built_in">this</span>.clickPrevious)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other objects must be able to switch the audio player&#x27;s</span></span><br><span class="line">    <span class="comment">// active state.</span></span><br><span class="line">    method <span class="title function_">changeState</span><span class="params">(state: State)</span> is</span><br><span class="line">        <span class="built_in">this</span>.state = state</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UI methods delegate execution to the active state.</span></span><br><span class="line">    method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">        state.clickLock()</span><br><span class="line">    method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">        state.clickPlay()</span><br><span class="line">    method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">        state.clickNext()</span><br><span class="line">    method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">        state.clickPrevious()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A state may call some service methods on the context.</span></span><br><span class="line">    method <span class="title function_">startPlayback</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">stopPlayback</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">nextSong</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">previousSong</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">fastForward</span><span class="params">(time)</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    method <span class="title function_">rewind</span><span class="params">(time)</span> is</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// The base state class declares methods that all concrete</span></span><br><span class="line"><span class="comment">// states should implement and also provides a backreference to</span></span><br><span class="line"><span class="comment">// the context object associated with the state. States can use</span></span><br><span class="line"><span class="comment">// the backreference to transition the context to another state.</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">State</span> is</span><br><span class="line">    <span class="keyword">protected</span> field player: AudioPlayer</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Context passes itself through the state constructor. This</span></span><br><span class="line">    <span class="comment">// may help a state fetch some useful context data if it&#x27;s</span></span><br><span class="line">    <span class="comment">// needed.</span></span><br><span class="line">    constructor <span class="title function_">State</span><span class="params">(player)</span> is</span><br><span class="line">        <span class="built_in">this</span>.player = player</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> method <span class="title function_">clickLock</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">abstract</span> method <span class="title function_">clickPlay</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">abstract</span> method <span class="title function_">clickNext</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">abstract</span> method <span class="title function_">clickPrevious</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Concrete states implement various behaviors associated with a</span></span><br><span class="line"><span class="comment">// state of the context.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LockedState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line"></span><br><span class="line">    <span class="comment">// When you unlock a locked player, it may assume one of two</span></span><br><span class="line">    <span class="comment">// states.</span></span><br><span class="line">    method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(player.playing)</span></span><br><span class="line">            player.changeState(<span class="keyword">new</span> <span class="title class_">PlayingState</span>(player))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            player.changeState(<span class="keyword">new</span> <span class="title class_">ReadyState</span>(player))</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// Locked, so do nothing.</span></span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// Locked, so do nothing.</span></span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">        <span class="comment">// Locked, so do nothing.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// They can also trigger state transitions in the context.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadyState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line">    method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">LockedState</span>(player))</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">        player.startPlayback()</span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">PlayingState</span>(player))</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">        player.nextSong()</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">        player.previousSong()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PlayingState</span> <span class="keyword">extends</span> <span class="title class_">State</span> is</span><br><span class="line">    method <span class="title function_">clickLock</span><span class="params">()</span> is</span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">LockedState</span>(player))</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPlay</span><span class="params">()</span> is</span><br><span class="line">        player.stopPlayback()</span><br><span class="line">        player.changeState(<span class="keyword">new</span> <span class="title class_">ReadyState</span>(player))</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickNext</span><span class="params">()</span> is</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(event.doubleclick)</span></span><br><span class="line">            player.nextSong()</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            player.fastForward(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">clickPrevious</span><span class="params">()</span> is</span><br><span class="line">        <span class="title function_">if</span> <span class="params">(event.doubleclick)</span></span><br><span class="line">            player.previous()</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            player.rewind(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Applicability-适用性"><a href="#Applicability-适用性" class="headerlink" title="Applicability 适用性"></a>Applicability 适用性</h2><ol>
<li>如果对象的行为根据其当前状态而有所不同，状态数量巨大，并且特定于状态的代码经常更改，请使用 State 模式。</li>
<li>该模式建议将所有特定于状态的代码提取到一组不同的类中。因此，您可以相互独立地添加新状态或更改现有状态，从而降低维护成本。</li>
<li>当类被大量条件污染时，请使用该模式，这些条件会根据类字段的当前值改变类的行为方式。</li>
<li>State 模式允许您将这些条件的分支提取到相应状态类的方法中。执行此操作时，还可以从主类中清除特定于状态的代码中涉及的临时字段和帮助程序方法。</li>
<li>当在基于条件的状态机的类似状态和转换中有许多重复代码时，请使用状态。</li>
<li>State 模式允许您编写状态类的层次结构，并通过将公共代码提取到抽象基类中来减少重复。</li>
</ol>
<h2 id="How-to-Implement-如何实现"><a href="#How-to-Implement-如何实现" class="headerlink" title="How to Implement 如何实现"></a>How to Implement 如何实现</h2><ol>
<li><p>确定哪个类将充当上下文。它可以是已经具有状态相关代码的现有类;或新类（如果特定于状态的代码分布在多个类中）。</p>
</li>
<li><p>声明状态接口。尽管它可以镜像上下文中声明的所有方法，但仅针对那些可能包含特定于状态的行为的方法。</p>
</li>
<li><p>对于每个实际状态，创建一个派生自状态接口的类。然后检查上下文的方法，并将与该状态相关的所有代码提取到新创建的类中。</p>
<p>将代码移动到 state 类时，您可能会发现它依赖于上下文的私有成员。有几种解决方法：</p>
<ul>
<li>将这些字段或方法设为公共。</li>
<li>将要提取的行为转换为上下文中的公共方法，并从 state 类中调用它。这种方式很丑陋，但速度很快，您可以随时稍后修复它。</li>
<li>将状态类嵌套到 context 类中，但前提是您的编程语言支持嵌套类。</li>
</ul>
</li>
<li><p>在上下文类中，添加状态接口类型的引用字段和允许重写该字段值的公共 setter 。</p>
</li>
<li><p>再次浏览上下文的方法，并将空状态条件替换为对状态对象的相应方法的调用。</p>
</li>
<li><p>若要切换上下文的状态，请创建其中一个状态类的实例并将其传递给上下文。您可以在上下文本身、各种状态或客户端中执行此操作。无论在哪里执行此操作，该类都依赖于它实例化的具体状态类。</p>
</li>
</ol>
<h2 id="Pros-and-Cons-优点和缺点"><a href="#Pros-and-Cons-优点和缺点" class="headerlink" title="Pros and Cons 优点和缺点"></a>Pros and Cons 优点和缺点</h2><table>
<thead>
<tr>
<th>优点√</th>
<th>缺点×</th>
</tr>
</thead>
<tbody><tr>
<td>单一责任原则。将与特定状态相关的代码组织到单独的类中。</td>
<td>如果状态机只有几个状态或很少更改，则应用该模式可能有点矫枉过正。</td>
</tr>
<tr>
<td>开&#x2F;闭原则。在不更改现有状态类或上下文的情况下引入新状态。</td>
<td></td>
</tr>
<tr>
<td>通过消除笨重的状态机条件来简化上下文的代码。</td>
<td></td>
</tr>
</tbody></table>
<h2 id="Relations-with-Other-Patterns-与其他模式的关系"><a href="#Relations-with-Other-Patterns-与其他模式的关系" class="headerlink" title="Relations with Other Patterns 与其他模式的关系"></a>Relations with Other Patterns 与其他模式的关系</h2><ul>
<li>桥接、状态、策略（在某种程度上还有适配器）具有非常相似的结构。事实上，所有这些模式都是基于构图的，而构图是将工作委托给其他对象。但是，它们都解决了不同的问题。模式不仅仅是以特定方式构建代码的秘诀。它还可以向其他开发人员传达该模式解决的问题。</li>
<li>状态可以看作是战略的延伸。这两种模式都基于组合：它们通过将一些工作委派给帮助对象来改变上下文的行为。策略使这些对象完全独立，彼此不相知。但是，State 不会限制具体状态之间的依赖关系，而是允许它们随意更改上下文的状态。</li>
</ul>
<h2 id="Code-Examples-代码示例"><a href="#Code-Examples-代码示例" class="headerlink" title="Code Examples 代码示例"></a>Code Examples 代码示例</h2><h1 id="State-in-Python"><a href="#State-in-Python" class="headerlink" title="State in Python"></a><strong>State</strong> in Python</h1><p>状态是一种行为设计模式，它允许对象在其内部状态更改时更改行为。</p>
<p>该模式将与状态相关的行为提取到单独的状态类中，并强制原始对象将工作委托给这些类的实例，而不是自行操作。</p>
<p>使用示例：状态模式在 Python 中常用于将大量 使用示例：状态模式在 Python 中常用于将大量 <code>switch</code> -base 状态机转换为对象。 -base 状态机转换为对象。</p>
<p>标识：状态模式可以通过根据对象状态改变其行为的方法识别，并由外部控制。</p>
<h2 id="Conceptual-Example-概念示例"><a href="#Conceptual-Example-概念示例" class="headerlink" title="Conceptual Example 概念示例"></a>Conceptual Example 概念示例</h2><p>此示例说明了状态设计模式的结构。它侧重于回答以下问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些课程扮演什么角色？</li>
<li>模式的元素以何种方式相关？</li>
</ul>
<h4 id="main-py：概念示例"><a href="#main-py：概念示例" class="headerlink" title="main.py：概念示例"></a>main.py：概念示例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Context</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The Context defines the interface of interest to clients. It also maintains</span></span><br><span class="line"><span class="string">    a reference to an instance of a State subclass, which represents the current</span></span><br><span class="line"><span class="string">    state of the Context.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _state = <span class="literal">None</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A reference to the current state of the Context.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, state: State</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.transition_to(state)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transition_to</span>(<span class="params">self, state: State</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        The Context allows changing the State object at runtime.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Context: Transition to <span class="subst">&#123;<span class="built_in">type</span>(state).__name__&#125;</span>&quot;</span>)</span><br><span class="line">        self._state = state</span><br><span class="line">        self._state.context = self</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The Context delegates part of its behavior to the current State object.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request1</span>(<span class="params">self</span>):</span><br><span class="line">        self._state.handle1()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request2</span>(<span class="params">self</span>):</span><br><span class="line">        self._state.handle2()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The base State class declares methods that all Concrete State should</span></span><br><span class="line"><span class="string">    implement and also provides a backreference to the Context object,</span></span><br><span class="line"><span class="string">    associated with the State. This backreference can be used by States to</span></span><br><span class="line"><span class="string">    transition the Context to another State.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">context</span>(<span class="params">self</span>) -&gt; Context:</span><br><span class="line">        <span class="keyword">return</span> self._context</span><br><span class="line"></span><br><span class="line"><span class="meta">    @context.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">context</span>(<span class="params">self, context: Context</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._context = context</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle1</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle2</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Concrete States implement various behaviors, associated with a state of the</span></span><br><span class="line"><span class="string">Context.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteStateA</span>(<span class="title class_ inherited__">State</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle1</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateA handles request1.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateA wants to change the state of the context.&quot;</span>)</span><br><span class="line">        self.context.transition_to(ConcreteStateB())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle2</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateA handles request2.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConcreteStateB</span>(<span class="title class_ inherited__">State</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle1</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateB handles request1.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle2</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateB handles request2.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ConcreteStateB wants to change the state of the context.&quot;</span>)</span><br><span class="line">        self.context.transition_to(ConcreteStateA())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># The client code.</span></span><br><span class="line"></span><br><span class="line">    context = Context(ConcreteStateA())</span><br><span class="line">    context.request1()</span><br><span class="line">    context.request2()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Output-txt-Execution-result"><a href="#Output-txt-Execution-result" class="headerlink" title="Output.txt: Execution result"></a><strong>Output.txt:</strong> Execution result</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Context: Transition to ConcreteStateA</span><br><span class="line">ConcreteStateA handles request1.</span><br><span class="line">ConcreteStateA wants to change the state of the context.</span><br><span class="line">Context: Transition to ConcreteStateB</span><br><span class="line">ConcreteStateB handles request2.</span><br><span class="line">ConcreteStateB wants to change the state of the context.</span><br><span class="line">Context: Transition to ConcreteStateA</span><br></pre></td></tr></table></figure>

<h1 id="State-in-Rust"><a href="#State-in-Rust" class="headerlink" title="State in Rust"></a><strong>State</strong> in Rust</h1><p>状态是一种行为设计模式，它允许对象在其内部状态更改时更改行为。</p>
<p>该模式将与状态相关的行为提取到单独的状态类中，并强制原始对象将工作委托给这些类的实例，而不是自行操作。</p>
<p>状态模式与有限状态机 （FSM） 概念相关，但是，每个状态都由实现公共状态特征的单独类型表示，而不是实现大量条件语句。状态之间的转换取决于每种状态类型的特定特征实现。</p>
<h2 id="Music-Player-音乐播放器"><a href="#Music-Player-音乐播放器" class="headerlink" title="Music Player 音乐播放器"></a>Music Player 音乐播放器</h2><p>让我们构建一个具有以下状态转换的音乐播放器：</p>
<div align="center"> <img src="/images/state-code-rust-example.jpeg"/><p style="text-align: center;"></p></div>


<p>有一个基本特征 <code>State</code> 和 <code>play</code> <code>stop</code> 方法，可以进行状态转换：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stop</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>next</code> 和 <code>prev</code> 不会改变状态，它们在一个单独的 <code>impl dyn State</code> 块中有默认实现，无法被重写。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">dyn</span> State &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">next</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">prev</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个状态都是实现以下各项的 <code>trait State</code> 类型：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">StoppedState</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PausedState</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PlayingState</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> <span class="keyword">for</span> <span class="title class_">StoppedState</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> <span class="keyword">for</span> <span class="title class_">PausedState</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无论如何，它的工作原理如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">state</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(StoppedState);   <span class="comment">// StoppedState.</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">state</span> = state.<span class="title function_ invoke__">play</span>(&amp;<span class="keyword">mut</span> player);  <span class="comment">// StoppedState -&gt; PlayingState.</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">state</span> = state.<span class="title function_ invoke__">play</span>(&amp;<span class="keyword">mut</span> player);  <span class="comment">// PlayingState -&gt; PausedState.</span></span><br></pre></td></tr></table></figure>

<p>在这里，相同的操作 <code>play</code> 会根据调用位置转换到不同的状态：</p>
<ol>
<li><p><code>StoppedState</code> <code>play</code> 的实现开始播放并返回 <code>PlayingState</code> 。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">    player.<span class="title function_ invoke__">play</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stopped -&gt; Playing.</span></span><br><span class="line">    <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(PlayingState)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>PlayingState</code> 再次点击“播放”按钮后暂停播放：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fn play(self: Box&lt;Self&gt;, player: &amp;mut Player) -&gt; Box&lt;dyn State&gt; &#123;</span><br><span class="line">    player.pause();</span><br><span class="line"></span><br><span class="line">    // Playing -&gt; Paused.</span><br><span class="line">    Box::new(PausedState)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>这些方法使用特殊 <code>self: Box&lt;Self&gt;</code> 表示法定义。</p>
<p>为什么？</p>
<ol>
<li>首先， <code>self</code> 不是引用，它意味着该方法是“一次性”，它销毁 <code>self</code> 并交换到另一个状态返回 <code>Box&lt;dyn State&gt;</code> 。</li>
<li>其次，该方法使用<code>Box</code>对象 <code>Box&lt;dyn State&gt;</code> 而不是具体类型的对象 <code>PlayingState</code> ，因为具体状态在编译时是未知的。</li>
</ol>
<h4 id="player-rs"><a href="#player-rs" class="headerlink" title="player.rs"></a><strong>player.rs</strong></h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A music track.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Track</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> duration: <span class="type">u32</span>,</span><br><span class="line">    cursor: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Track</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(title: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>, duration: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            title: title.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            duration,</span><br><span class="line">            cursor: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A music player holds a playlist and it can do basic operations over it.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    playlist: <span class="type">Vec</span>&lt;Track&gt;,</span><br><span class="line">    current_track: <span class="type">usize</span>,</span><br><span class="line">    _volume: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Default</span> <span class="keyword">for</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">default</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            playlist: <span class="built_in">vec!</span>[</span><br><span class="line">                Track::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Track 1&quot;</span>, <span class="number">180</span>),</span><br><span class="line">                Track::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Track 2&quot;</span>, <span class="number">165</span>),</span><br><span class="line">                Track::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Track 3&quot;</span>, <span class="number">197</span>),</span><br><span class="line">                Track::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Track 4&quot;</span>, <span class="number">205</span>),</span><br><span class="line">            ],</span><br><span class="line">            current_track: <span class="number">0</span>,</span><br><span class="line">            _volume: <span class="number">25</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">next_track</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.current_track = (<span class="keyword">self</span>.current_track + <span class="number">1</span>) % <span class="keyword">self</span>.playlist.<span class="title function_ invoke__">len</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">prev_track</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.current_track = (<span class="keyword">self</span>.playlist.<span class="title function_ invoke__">len</span>() + <span class="keyword">self</span>.current_track - <span class="number">1</span>) % <span class="keyword">self</span>.playlist.<span class="title function_ invoke__">len</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">play</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">track_mut</span>().cursor = <span class="number">10</span>; <span class="comment">// Playback imitation.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pause</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">track_mut</span>().cursor = <span class="number">43</span>; <span class="comment">// Paused at some moment.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">rewind</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">track_mut</span>().cursor = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">track</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;Track &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.playlist[<span class="keyword">self</span>.current_track]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">track_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> Track &#123;</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.playlist[<span class="keyword">self</span>.current_track]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="state-rs"><a href="#state-rs" class="headerlink" title="state.rs"></a><strong>state.rs</strong></h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> cursive::views::TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::player::Player;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">StoppedState</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PausedState</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PlayingState</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// There is a base `State` trait with methods `play` and `stop` which make</span></span><br><span class="line"><span class="comment">/// state transitions. There are also `next` and `prev` methods in a separate</span></span><br><span class="line"><span class="comment">/// `impl dyn State` block below, those are default implementations</span></span><br><span class="line"><span class="comment">/// that cannot be overridden.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// What is the `self: Box&lt;Self&gt;` notation? We use the state as follows:</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">///   let prev_state = Box::new(PlayingState);</span></span><br><span class="line"><span class="comment">///   let next_state = prev_state.play(&amp;mut player);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// A method `play` receives a whole `Box&lt;PlayingState&gt;` object,</span></span><br><span class="line"><span class="comment">/// and not just `PlayingState`. The previous state &quot;disappears&quot; in the method,</span></span><br><span class="line"><span class="comment">/// in turn, it returns a new `Box&lt;PausedState&gt;` state object.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">State</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stop</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, player: &amp;Player, view: &amp;<span class="keyword">mut</span> TextView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> <span class="keyword">for</span> <span class="title class_">StoppedState</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">play</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stopped -&gt; Playing.</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(PlayingState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stop</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, _: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        <span class="comment">// Change no state.</span></span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, _: &amp;Player, view: &amp;<span class="keyword">mut</span> TextView) &#123;</span><br><span class="line">        view.<span class="title function_ invoke__">set_content</span>(<span class="string">&quot;[Stopped] Press &#x27;Play&#x27;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> <span class="keyword">for</span> <span class="title class_">PausedState</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">pause</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Paused -&gt; Playing.</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(PlayingState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stop</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">pause</span>();</span><br><span class="line">        player.<span class="title function_ invoke__">rewind</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Paused -&gt; Stopped.</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(StoppedState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, player: &amp;Player, view: &amp;<span class="keyword">mut</span> TextView) &#123;</span><br><span class="line">        view.<span class="title function_ invoke__">set_content</span>(<span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;[Paused] &#123;&#125; - &#123;&#125; sec&quot;</span>,</span><br><span class="line">            player.<span class="title function_ invoke__">track</span>().title,</span><br><span class="line">            player.<span class="title function_ invoke__">track</span>().duration</span><br><span class="line">        ))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">State</span> <span class="keyword">for</span> <span class="title class_">PlayingState</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">play</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">pause</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Playing -&gt; Paused.</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(PausedState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stop</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">pause</span>();</span><br><span class="line">        player.<span class="title function_ invoke__">rewind</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Playing -&gt; Stopped.</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(StoppedState)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">render</span>(&amp;<span class="keyword">self</span>, player: &amp;Player, view: &amp;<span class="keyword">mut</span> TextView) &#123;</span><br><span class="line">        view.<span class="title function_ invoke__">set_content</span>(<span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;[Playing] &#123;&#125; - &#123;&#125; sec&quot;</span>,</span><br><span class="line">            player.<span class="title function_ invoke__">track</span>().title,</span><br><span class="line">            player.<span class="title function_ invoke__">track</span>().duration</span><br><span class="line">        ))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default &quot;next&quot; and &quot;prev&quot; implementations for the trait.</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">dyn</span> State &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">next</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">next_track</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Change no state.</span></span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">prev</span>(<span class="keyword">self</span>: <span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;, player: &amp;<span class="keyword">mut</span> Player) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt; &#123;</span><br><span class="line">        player.<span class="title function_ invoke__">prev_track</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Change no state.</span></span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="main-rs"><a href="#main-rs" class="headerlink" title="main.rs"></a><strong>main.rs</strong></h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> player;</span><br><span class="line"><span class="keyword">mod</span> state;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> cursive::&#123;</span><br><span class="line">    event::Key,</span><br><span class="line">    view::Nameable,</span><br><span class="line">    views::&#123;Dialog, TextView&#125;,</span><br><span class="line">    Cursive,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> player::Player;</span><br><span class="line"><span class="keyword">use</span> state::&#123;State, StoppedState&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Application context: a music player and a state.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PlayerApplication</span> &#123;</span><br><span class="line">    player: Player,</span><br><span class="line">    state: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> State&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">app</span> = cursive::<span class="title function_ invoke__">default</span>();</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">set_user_data</span>(PlayerApplication &#123;</span><br><span class="line">        player: Player::<span class="title function_ invoke__">default</span>(),</span><br><span class="line">        state: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(StoppedState),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">add_layer</span>(</span><br><span class="line">        Dialog::<span class="title function_ invoke__">around</span>(TextView::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Press Play&quot;</span>).<span class="title function_ invoke__">with_name</span>(<span class="string">&quot;Player Status&quot;</span>))</span><br><span class="line">            .<span class="title function_ invoke__">title</span>(<span class="string">&quot;Music Player&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">button</span>(<span class="string">&quot;Play&quot;</span>, |s| <span class="title function_ invoke__">execute</span>(s, <span class="string">&quot;Play&quot;</span>))</span><br><span class="line">            .<span class="title function_ invoke__">button</span>(<span class="string">&quot;Stop&quot;</span>, |s| <span class="title function_ invoke__">execute</span>(s, <span class="string">&quot;Stop&quot;</span>))</span><br><span class="line">            .<span class="title function_ invoke__">button</span>(<span class="string">&quot;Prev&quot;</span>, |s| <span class="title function_ invoke__">execute</span>(s, <span class="string">&quot;Prev&quot;</span>))</span><br><span class="line">            .<span class="title function_ invoke__">button</span>(<span class="string">&quot;Next&quot;</span>, |s| <span class="title function_ invoke__">execute</span>(s, <span class="string">&quot;Next&quot;</span>)),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">add_global_callback</span>(Key::Esc, |s| s.<span class="title function_ invoke__">quit</span>());</span><br><span class="line"></span><br><span class="line">    app.<span class="title function_ invoke__">run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">execute</span>(s: &amp;<span class="keyword">mut</span> Cursive, button: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">PlayerApplication</span> &#123;</span><br><span class="line">        <span class="keyword">mut</span> player,</span><br><span class="line">        <span class="keyword">mut</span> state,</span><br><span class="line">    &#125; = s.<span class="title function_ invoke__">take_user_data</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">view</span> = s.find_name::&lt;TextView&gt;(<span class="string">&quot;Player Status&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Here is how state mechanics work: the previous state</span></span><br><span class="line">    <span class="comment">// executes an action and returns a new state.</span></span><br><span class="line">    <span class="comment">// Each state has all 4 operations but reacts differently.</span></span><br><span class="line">    state = <span class="keyword">match</span> button &#123;</span><br><span class="line">        <span class="string">&quot;Play&quot;</span> =&gt; state.<span class="title function_ invoke__">play</span>(&amp;<span class="keyword">mut</span> player),</span><br><span class="line">        <span class="string">&quot;Stop&quot;</span> =&gt; state.<span class="title function_ invoke__">stop</span>(&amp;<span class="keyword">mut</span> player),</span><br><span class="line">        <span class="string">&quot;Prev&quot;</span> =&gt; state.<span class="title function_ invoke__">prev</span>(&amp;<span class="keyword">mut</span> player),</span><br><span class="line">        <span class="string">&quot;Next&quot;</span> =&gt; state.<span class="title function_ invoke__">next</span>(&amp;<span class="keyword">mut</span> player),</span><br><span class="line">        _ =&gt; <span class="built_in">unreachable!</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    state.<span class="title function_ invoke__">render</span>(&amp;player, &amp;<span class="keyword">mut</span> view);</span><br><span class="line"></span><br><span class="line">    s.<span class="title function_ invoke__">set_user_data</span>(PlayerApplication &#123; player, state &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h3><div align="center"> <img src="/images/state-rust-example-screenshots1.png"/><p style="text-align: center;"></p></div>





<div align="center"> <img src="/images/state-rust-example-screenshots2.png"/><p style="text-align: center;"></p></div>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/93/">93</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ice</p>
  <div class="site-description" itemprop="description">安静地坐着学习</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/TonyMistark" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;TonyMistark" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/Micestark" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;Micestark" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tony_mistark@163.com" title="E-Mail → mailto:tony_mistark@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Tony_Mistark" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Tony_Mistark" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ice</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">183k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">11:06</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
